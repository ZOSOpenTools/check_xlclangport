export ZOPEN_TYPE="BARE"

export ZOPEN_NAME="ibm_xlclang"
export ZOPEN_CONFIGURE=skip
export ZOPEN_CHECK=skip
export ZOPEN_MAKE=skip
export ZOPEN_INSTALL=zopen_install

zopen_append_to_env()
{
cat <<zz
  if [ ! -z "\$ZOPEN_IN_ZOPEN_BUILD" ]; then
    # Find the path to xlclang
    XLCLANG_PATH=\$(PATH="\$ZOPEN_OLD_PATH" /bin/type xlclang | cut -f3 -d' ')
  else
    XLCLANG_PATH=\$(/bin/type xlclang | cut -f3 -d' ')
  fi

  # If xlclang is not found, exit with an error message
  if [ -z "\${XLCLANG_PATH}" ]; then
      echo "xlclang not found"
      return 1
  fi

  if [ ! -z "\$ZOPEN_IN_ZOPEN_BUILD" ]; then
    # Set the PATH environment variable to the directory of the xlclang path
    export PATH="\$(dirname "\${XLCLANG_PATH}"):\${PATH}"
    export CC="xlclang"
    export CXX="xlclang++"
    export ZOPEN_CPPFLAGS="-DNSIG=42 -D_XOPEN_SOURCE=600 -D_ALL_SOURCE -D_OPEN_SYS_FILE_EXT=1 -D_AE_BIMODAL=1 -D_ENHANCED_ASCII_EXT=0xFFFFFFFF"
    export ZOPEN_CFLAGS="-qascii -std=gnu11 -qnocsect -qenum=int -qgonumber"
    export ZOPEN_CXXFLAGS="-+ -qascii -qnocsect -qenum=int -qgonumber"
    export ZOPEN_LDFLAGS="-Wl,edit=no"

    if \$buildInReleaseMode; then
      ZOPEN_CFLAGS="\${ZOPEN_CFLAGS} -O3";
      ZOPEN_CXXFLAGS="\${ZOPEN_CXXFLAGS} -O3";
    else
      ZOPEN_LDFLAGS=""
    fi

    ccraw=\$(touch \$TEMP_C_FILE && \${CC} -E -qshowmacros \$TEMP_C_FILE | grep '__COMPILER_VER__' | awk '{print substr(\$3,3)}')
    if [ "\${ccraw}x" = "x" ]; then
      echo "xlclang compiler specified, but it is not a 'IBM C/C++ for Open Enterprise Languages on z/OS' compiler"
      return 1
    fi
    if [ \${ccraw} -lt 42040001 ] ; then
      echo "xlclang compiler specified, need to be running IBM C for Open Enterprise Languages on z/OS 1"
      return 1
    fi

    # Confirm xlclang is OEL 1.0.0 (aka __COMPILER_VER__=42040001)
    ccraw=\$(touch \$TEMP_C_FILE && \${CXX} -+ -E -qshowmacros \$TEMP_C_FILE | grep '__COMPILER_VER__' | awk '{print substr(\$3,3)}')
    if [ "\${ccraw}x" = "x" ]; then
      echo "xlclang++ compiler specified, but it is not a 'IBM C/C++ for Open Enterprise Languages on z/OS' compiler"
      return 1
    fi
    if [ \${ccraw} -lt 42040001 ] ; then
      echo "xlclang++ compiler specified, need to be running IBM C for Open Enterprise Languages on z/OS 1"
      return 1
    fi
  fi
zz
}

zopen_install() {
  mkdir -p $ZOPEN_INSTALL_DIR
}
